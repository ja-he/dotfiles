#!/usr/bin/bash
set -euo pipefail

_init_with_submodules() {
  (
    set -x
    submodules="${1}"
    git clone "${main_repo}" "${zettelkasten_path}"
    cd "${zettelkasten_path}"
    for submodule_dir in ${submodules}; do
      (
        cd "${submodule_dir}"
        git submodule update --init .
        git checkout main
      )
    done
  )
}

_update_toplevel()
{
  (
    set -x
    cd "${zettelkasten_path}"
    git pull
    for submodule_dir in ${ZETTELKASTEN_KAESTEN}; do
      git add ${submodule_dir}
    done
    git commit -m "Update to submodule(s)"
    git push
  )
}

update_kasten()
{
  local category=${1}
  (
    set -x
    cd "${zettelkasten_path}/${category}"
    git pull
    git add .
    git commit -m "$day Update"
    git push
  )
}

edit_zettel()
{
  local kasten=${1}
  local zettel=${2}

  local zettel_dir
  case ${kasten} in
    public | namib | work)
      zettel_dir=${zettelkasten_path}/${kasten}
      ;;
    private)
      zettel_dir=${zettelkasten_path}/${kasten}/${day}
      ;;
    *)
      echo "ERROR: kasten ${kasten} not known"
      exit 1
      ;;
  esac

  mkdir -p ${zettel_dir}
  nvim ${zettel_dir}/${zettel}
}

nvim_fzf_cmd()
{
  local kasten=${1}
  local fzfcmd=${2}
  nvim -c ":cd ${zettelkasten_path}/${kasten}" -c "${fzfcmd}"
}

# _get_kaesten() {
#   (
#     cd "${zettelkasten_path}"
#     git submodule status | while read hash repo branch; do echo $repo ; done 
#   )
# }

# usage sketch:
# $ zet <subcommand> [<kasten>] [<note>]
# $ zet update       [<kasten>]
# $ zet edit          <kasten>   <note>
# $ zet filesearch   [<kasten>]
# $ zet textsearch   [<kasten>]

main_repo='git@gitlab.informatik.uni-bremen.de:ja_he/zettelkasten.git'
default_path=${HOME}/zettelkasten
zettelkasten_path=${ZETTELKASTENPATH:-${default_path}}
zettelkasten_path="$(readlink -m ${zettelkasten_path})"
zettelkasten_kaesten="${ZETTELKASTEN_KAESTEN:-"namib private"}"
day=`date '+%Y-%m-%d'`

command=${1}

case ${command} in
  init)
    _init_with_submodules "${zettelkasten_kaesten}"
    ;;
  update)
    kasten_arg="${2:-""}"
    if [ -n "${kasten_arg}" ]; then
      # update specified kasten
      update_kasten "${kasten_arg}"
    else
      # update all kaesten
      for kasten in ${zettelkasten_kaesten}; do
        update_kasten "${kasten}"
      done
    fi
    _update_toplevel
    exit 0
    ;;
  edit)
    edit_zettel ${2} ${3}
    ;;
  filesearch)
    nvim_fzf_cmd ${2:-public} ':Files'
    ;;
  textsearch)
    nvim_fzf_cmd ${2:-public} ':Ag'
    ;;
  *)
    echo "ERROR: unrecognized command '${command}'"
    exit 1
esac
